(()=>{"use strict";const e=this,t=(t,a)=>{console.log(e.global,e.setGlobal);return(0,e.global)(t)||((0,e.setGlobal)(t,a),a)},a="Tasker",l=t("%WallpaperMaxWallpapers",1e3),r=a+"/wallpaper/previous.json",i=a+"/wallpaper/images",o=t("%WallpaperClientBaseUrl","https://www.troddit.com"),n=t("%WallpaperRedditSourceUrl","https://reddit.com/r/art.json"),s=t("%WallpaperMinWidth",1080),d=t("%WallpaperMinHeight",1920),h=({url:e})=>RegExp(".(jpg|png|jpeg)$","i").test(e),c=(t,a=r)=>(0,e.writeFile)(a,JSON.stringify(t)),p=(t,a)=>(0,e.performTask)("WallpaperNotification",10,t,a),g=(t=i)=>{const a=(0,e.listFiles)(t);return a?a.split("\n").reduce(((e,t)=>{const a=t.match(/(\w+)\.\w{3,4}$/);return a?(e.push({id:a[1],filePath:t}),e):e}),[]):[]},w=(t,a=i,l=r)=>{console.log("Start offline");const n=g(a),s=t.filter((e=>Boolean(e)));if(!n.length||!t.length)return(0,e.flash)("Could not set offline wallpaper with no cached images"),t;const d=s.pop(),h=n.find((({id:e})=>e===d.id));return h||w(s),(0,e.setWallpaper)(h.filePath),p(d.title,`${o}${d.permalink}`),(0,e.setGlobal)("WallpaperPostUrl",`${o}${d.permalink}`),d.displayedLast=Date.now(),s.unshift(d),s.length=t.length,c(s,l),s},m=w,u=({width:e,height:t})=>e>=s&&t>=d,f=(t,a)=>new Promise(((l,r)=>{const i=new Image;i.onload=function(){const t=document.createElement("canvas"),i=t.getContext("2d"),o=d/this.height;t.width=this.width*o,t.height=d,i.drawImage(this,0,0,t.width,t.height);const n=`echo '${t.toDataURL("image/jpeg",.8).match(/^data:image\/[a-z]+;base64,(?<base>.+)$/).groups.base}' | base64 -d > /storage/emulated/0/${a} && echo done`;return(0,e.shell)(n,!1,45)?l():r(new Error(`shell command failed Tasker JS does not include error, ${n}`))},i.src=t})),$=async(t=[],a,s=i,d=r,g=null)=>{const[w,m]=await(async t=>{const a=await(0,e.fetch)(`${n}?limit=100${t?`&after=${t}`:""}`),l=await a.json(),r=l.data.children.map((e=>(({id:e,title:t,permalink:a,url:l,preview:r})=>({id:e,title:t,permalink:a,url:l,width:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.width?r.images[0].source.width:0,height:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.height?r.images[0].source.height:0}))(e.data)));return[l.data.after,r.filter(h).filter(u)]})(a),b=m.find((e=>!t.find((t=>t&&t.id===e.id))));if(!b){if(!w)throw new Error("Can not paginate without a after parameter");if(Boolean(g)&&g>=Date.now())throw new Error("Could not find new wallpaper within timeout");return $(t,w,s,d)}const[W]=b.url.match(/\.\w{3,4}($|\?)/),y=`${s}/${b.id}${W}`;return await(async(t,a)=>{if((0,e.shell)("curl --help",!1,10))((t,a)=>{const l=`cd /storage/emulated/0 && curl -L -f -o "${a}" "${t}" && echo done`;if(!(0,e.shell)(l,!1,45))throw new Error(`Curl wallpaper download errored with commmand: ${l}`)})(t,a);else{if(!(0,e.shell)("base64 --help",!1,10))throw new Error("Neither curl or base64 commands precent in shell, no methods available to download image");await f(t,a)}})(b.url,y),(0,e.setWallpaper)(y),p(b.title,`${o}${b.permalink}`),(0,e.setGlobal)("WallpaperPostUrl",`${o}${b.permalink}`),b.displayedLast=Date.now(),t.unshift(b),t.length=l,c(t,d),t},b=async(e=[],t,a=i,l=r,o=3e4)=>{console.log("Start online");const n=Date.now()+o;return await $(e,t,a,l,n)};(async()=>{try{p("Updating wallpaper...");const t=((t=r)=>{try{return JSON.parse((0,e.readFile)(t)).sort(((e,t)=>e&&t?t.displayedLast-e.displayedLast:0)).filter(((e,t,a)=>!e||t===a.filter((e=>Boolean(e))).findIndex((t=>e.id===t.id))))}catch(a){"ENOENT"!==a.code&&console.error(a),(0,e.writeFile)(t,"[]")}return[]})(),[a,l]=(0,e.global)("%WIFII").match(/>>> (.+) <<</);(t=>{g().filter((({id:e})=>!t.find((t=>t&&t.id===e)))).forEach((({filePath:t})=>(0,e.deleteFile)(t)))})(await(!(0,e.global)("sdk")&&process.argv.includes("--online")?b:!(0,e.global)("sdk")&&process.argv.includes("--offline")?m:"CONNECTION"===l?b:m)(t))}catch(t){console.error(t),(0,e.flash)(t.toString())}(0,e.exit)()})()})();