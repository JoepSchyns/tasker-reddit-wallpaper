(()=>{"use strict";var e={297:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.MIN_HEIGHT=t.MIN_WIDTH=t.REDDIT_WALLPAPER_SOURCE_URL=t.REDDIT_CLIENT_BASE_URL=t.IMAGE_PATH=t.PREVIOUS_FILEPATH=t.MAX_WALLPAPERS=t.TASKER_PATH=void 0;var n=r(210),o=function(e,t){return(0,n.global)(e)||((0,n.setGlobal)(e,t),t)};t.TASKER_PATH="Tasker",t.MAX_WALLPAPERS=o("%WallpaperMaxWallpapers",1e3),t.PREVIOUS_FILEPATH="".concat(t.TASKER_PATH,"/wallpaper/previous.json"),t.IMAGE_PATH="".concat(t.TASKER_PATH,"/wallpaper/images"),t.REDDIT_CLIENT_BASE_URL=o("%WallpaperClientBaseUrl","https://www.troddit.com"),t.REDDIT_WALLPAPER_SOURCE_URL=o("%WallpaperRedditSourceUrl","https://reddit.com/r/art.json"),t.MIN_WIDTH=o("%WallpaperMinWidth",1080),t.MIN_HEIGHT=o("%WallpaperMinHeight",1920)},488:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.cleanCached=t.getCachedWithIds=t.sendNotification=t.writePrevious=t.readOrCreatePrevious=t.isImage=void 0;var n=r(297),o=r(210);t.isImage=function(e){return RegExp(".(jpg|png|jpeg)$","i").test(e)},t.readOrCreatePrevious=function(e){void 0===e&&(e=n.PREVIOUS_FILEPATH);try{return JSON.parse((0,o.readFile)(e).toString()).sort((function(e,t){return e&&t?t.displayedLast-e.displayedLast:0})).filter((function(e,t,r){return!e||t===r.filter((function(e){return Boolean(e)})).findIndex((function(t){return e.id===t.id}))}))}catch(t){"ENOENT"!==t.code&&console.error(t),(0,o.writeFile)(e,"[]")}return[]},t.writePrevious=function(e,t){return void 0===t&&(t=n.PREVIOUS_FILEPATH),(0,o.writeFile)(t,JSON.stringify(e))},t.sendNotification=function(e,t){return(0,o.performTask)("WallpaperNotification",10,e,t)},t.getCachedWithIds=function(e){void 0===e&&(e=n.IMAGE_PATH);var t=(0,o.listFiles)(e);return t?t.split("\n").reduce((function(e,t){var r=t.match(/(\w+)\.\w{3,4}$/);return r?(e.push({id:r[1],filePath:t}),e):e}),[]):[]},t.cleanCached=function(e){return(0,t.getCachedWithIds)().filter((function(t){var r=t.id;return!e.find((function(e){return e&&e.id===r}))})).forEach((function(e){var t=e.filePath;return(0,o.deleteFile)(t)}))}},607:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function l(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,l)}c((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(c){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(r=1,n&&(o=2&l[0]?n.return:l[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,l[1])).done)return o;switch(n=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,n=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){a.label=l[1];break}if(6===l[0]&&a.label<o[1]){a.label=o[1],o=l;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(l);break}o[2]&&a.ops.pop(),a.trys.pop();continue}l=t.call(e,a)}catch(e){l=[6,e],n=0}finally{r=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,c])}}};Object.defineProperty(t,"__esModule",{value:!0});var i=r(210),a=r(488),l=r(245),c=r(639);n(void 0,void 0,void 0,(function(){var e,t,r,n,u;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),(0,a.sendNotification)("Updating wallpaper..."),e=(0,a.readOrCreatePrevious)(),t=(0,i.global)("%WIFII").match(/>>> (.+) <<</),r=t[1],[4,(!(0,i.global)("sdk")&&process.argv.includes("--online")?c.default:!(0,i.global)("sdk")&&process.argv.includes("--offline")?l.default:"CONNECTION"===r?c.default:l.default)(e)];case 1:return n=o.sent(),(0,a.cleanCached)(n),[3,3];case 2:return u=o.sent(),console.error(u),(0,i.flash)(u.toString()),[3,3];case 3:return(0,i.exit)(),[2]}}))}))},245:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var n=r(297),o=r(210),i=r(488),a=function(e,t,r){void 0===t&&(t=n.IMAGE_PATH),void 0===r&&(r=n.PREVIOUS_FILEPATH),console.log("Start offline");var l=(0,i.getCachedWithIds)(t),c=e.filter((function(e){return Boolean(e)}));if(0===l.length||0===c.length)return(0,o.flash)("Could not set offline wallpaper with no cached images"),e;var u=c.pop();if(!u)throw new Error("Could not pop from array");var s=l.find((function(e){return e.id===u.id}));return s?((0,o.setWallpaper)(s.filePath),(0,i.sendNotification)(u.title,"".concat(n.REDDIT_CLIENT_BASE_URL).concat(u.permalink)),(0,o.setGlobal)("WallpaperPostUrl","".concat(n.REDDIT_CLIENT_BASE_URL).concat(u.permalink)),u.displayedLast=Date.now(),c.unshift(u),c.length=e.length,(0,i.writePrevious)(c,r),c):a(c)};t.default=a},639:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function l(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,l)}c((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(c){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(r=1,n&&(o=2&l[0]?n.return:l[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,l[1])).done)return o;switch(n=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,n=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){a.label=l[1];break}if(6===l[0]&&a.label<o[1]){a.label=o[1],o=l;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(l);break}o[2]&&a.ops.pop(),a.trys.pop();continue}l=t.call(e,a)}catch(e){l=[6,e],n=0}finally{r=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,c])}}};Object.defineProperty(t,"__esModule",{value:!0});var i=r(297),a=r(210),l=r(488),c=function(e){var t=e.width,r=e.height;return t>=i.MIN_WIDTH&&r>=i.MIN_HEIGHT},u=function(e){return n(void 0,void 0,void 0,(function(){var t,r;return o(this,(function(n){switch(n.label){case 0:return[4,fetch("".concat(i.REDDIT_WALLPAPER_SOURCE_URL,"?limit=100").concat(e?"&after=".concat(e):""))];case 1:return[4,n.sent().json()];case 2:return t=n.sent(),r=t.data.children.map((function(e){return function(e){var t=e.id,r=e.title,n=e.permalink,o=e.url,i=e.preview;return{id:t,title:r,permalink:n,url:o,width:i&&i.images&&i.images.length&&i.images[0].source&&i.images[0].source.width?i.images[0].source.width:0,height:i&&i.images&&i.images.length&&i.images[0].source&&i.images[0].source.height?i.images[0].source.height:0}}(e.data)})),[2,[t.data.after,r.filter((function(e){var t=e.url;return(0,l.isImage)(t)})).filter(c)]]}}))}))},s=function(e,t){return new Promise((function(r,n){var o=new Image;o.onload=function(){var e,l,c=document.createElement("canvas");if(!c)throw new Error("Could not get canvas");var u=c.getContext("2d");if(!u)throw new Error("Could not get context");var s=i.MIN_HEIGHT/o.height;c.width=o.width*s,c.height=i.MIN_HEIGHT,u.drawImage(o,0,0,c.width,c.height);var d=null===(l=null===(e=c.toDataURL("image/jpeg",.8).match(/^data:image\/[a-z]+;base64,(?<base>.+)$/))||void 0===e?void 0:e.groups)||void 0===l?void 0:l.base;if(!d)throw new Error("Base64 is not generated");var f="echo '".concat(d,"' | base64 -d > /storage/emulated/0/").concat(t," && echo done");return(0,a.shell)(f,!1,45)?r():n(new Error("shell command failed Tasker JS does not include error, ".concat(f)))},o.src=e}))},d=function(e,t){return n(void 0,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:return(0,a.shell)("curl --help",!1,10)?(function(e,t){var r='cd /storage/emulated/0 && curl -L -f -o "'.concat(t,'" "').concat(e,'" && echo done');if(!(0,a.shell)(r,!1,45))throw new Error("Curl wallpaper download errored with commmand: ".concat(r))}(e,t),[3,4]):[3,1];case 1:return(0,a.shell)("base64 --help",!1,10)?[4,s(e,t)]:[3,3];case 2:return r.sent(),[3,4];case 3:throw new Error("Neither curl or base64 commands precent in shell, no methods available to download image");case 4:return[2]}}))}))},f=function(e,t,r,c,s){return void 0===e&&(e=[]),void 0===c&&(c=i.IMAGE_PATH),void 0===s&&(s=i.PREVIOUS_FILEPATH),n(void 0,void 0,void 0,(function(){var n,h,p,v,w,E;return o(this,(function(o){switch(o.label){case 0:return[4,u(r)];case 1:if(n=o.sent(),h=n[0],p=n[1],!(v=p.find((function(t){return!e.find((function(e){return e&&e.id===t.id}))})))){if(!h)throw new Error("Can not paginate without a after parameter");if(t<Date.now())throw new Error("Could not find new wallpaper within timeout");return[2,f(e,t,h,c,s)]}if(!(w=v.url.match(/\.\w{3,4}($|\?)/)))throw new Error("Extention of the image could not be found");return E="".concat(c,"/").concat(v.id).concat(w[0]),[4,d(v.url,E)];case 2:return o.sent(),(0,a.setWallpaper)(E),(0,l.sendNotification)(v.title,"".concat(i.REDDIT_CLIENT_BASE_URL).concat(v.permalink)),(0,a.setGlobal)("WallpaperPostUrl","".concat(i.REDDIT_CLIENT_BASE_URL).concat(v.permalink)),v.firstSeen=Date.now(),e.push(v),e.sort((function(e,t){return t.firstSeen-e.firstSeen})),e.length=i.MAX_WALLPAPERS,(0,l.writePrevious)(e,s),[2,e]}}))}))};t.default=function(e,t,r,a,l){return void 0===e&&(e=[]),void 0===r&&(r=i.IMAGE_PATH),void 0===a&&(a=i.PREVIOUS_FILEPATH),void 0===l&&(l=3e4),n(void 0,void 0,void 0,(function(){var n;return o(this,(function(o){return console.log("Start online"),n=Date.now()+l,[2,f(e,n,t,r,a)]}))}))}},210:e=>{e.exports=this}},t={};!function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}(607)})();