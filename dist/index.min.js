(()=>{"use strict";const e=this,t="Tasker/wallpaper/previous.json",i=(i,a=t)=>(0,e.writeFile)(a,JSON.stringify(i)),a=(t,i)=>(0,e.performTask)("WallpaperNotification",10,t,i),r=()=>{const t=(0,e.listFiles)("Tasker/wallpaper/images");return t?t.split("\n").map((e=>({id:e.match(/(\w+)\.\w{3,4}/)[1],filePath:e}))):[]},l=({url:e})=>RegExp(".(jpg|png|jpeg)$","i").test(e),s=({width:e,height:t})=>e>=1080&&t>=1920,n=t=>r().filter((({id:e})=>!t.find((t=>t&&t.id===e)))).forEach((({filePath:t})=>(0,e.deleteFile)(t)));(async()=>{try{a("Updating wallpaper...");const o=((i=t)=>{try{return JSON.parse((0,e.readFile)(i)).sort(((e,t)=>e&&t?t.displayedLast-e.displayedLast:0)).filter(((e,t,i)=>!e||t===i.filter((e=>!!e)).findIndex((t=>e.id===t.id))))}catch(t){"ENOENT"!==t.code&&console.error(t),(0,e.writeFile)(i,"[]")}return[]})(),[d,p]=(0,e.global)("%WIFII").match(/>>> (.+) <<</);if("CONNECTION"===p){console.log("online");const t=await(async(t,r)=>{const[n,o]=await(async t=>{const i=await(0,e.fetch)("https://reddit.com/r/art.json?limit=100"+(t?`&after=${t}`:"")),a=await i.json(),r=a.data.children.map((e=>(({id:e,title:t,permalink:i,url:a,preview:r})=>({id:e,title:t,permalink:i,url:a,width:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.width?r.images[0].source.width:0,height:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.height?r.images[0].source.height:0}))(e.data)));return[a.data.after,r.filter(l).filter(s)]})(r),d=o.find((e=>!t.find((t=>t&&t.id===e.id))));if(!d){if(!n)throw new Error("Can not paginate without a after parameter");return online(t,n)}const[p]=d.url.match(/\.\w{3,4}($|\?)/),c=`Tasker/wallpaper/images/${d.id}${p}`;await((t,i,a=30)=>new Promise(((r,l)=>{if((0,e.shell)(`cd /storage/emulated/0 && curl -L -f -o "${i}" "${t}" && echo d`,!1,a))return r();l(`Could not download ${t} to /storage/emulated/0/${i}`)})))(d.url,c),(0,e.setWallpaper)(c),a(d.title,`https://reddit.premii.com/#${d.permalink}`),d.displayedLast=Date.now(),t.unshift(d);const h=(0,e.global)("%WallpaperMemLength");return h||(0,e.setGlobal)("%WallpaperMemLength",1e3),t.length=h||1e3,i(t),t})(o);n(t)}else{console.log("offline");const t=await(t=>{const l=r(),s=t.filter((e=>!!e));if(!l.length||!t.length)return flash("Could not set offline wallpaper no cached image"),t;const n=s.pop(),o=l.find((({id:e})=>e===n.id));return o||offline(s),(0,e.setWallpaper)(o.filePath),a(n.title,`https://reddit.premii.com/#${n.permalink}`),n.displayedLast=Date.now(),s.unshift(n),s.length=t.length,i(s),t})(o);n(t)}}catch(t){console.error(t),(0,e.flash)(t.toString())}(0,e.exit)()})()})();