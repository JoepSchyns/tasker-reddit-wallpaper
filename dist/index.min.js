const isImage=({url:e})=>RegExp(".(jpg|png|jpeg)$","i").test(e),isLargeEnough=({width:e,height:t})=>1080<=e&&1920<=t,getWallpaperPosts=async e=>{const t=await fetch(`https://reddit.com/r/art.json?limit=100${e?`&after=${e}`:""}`),a=await t.json(),i=a.data.children.map(e=>(({id:e,title:t,permalink:a,url:i,preview:r})=>({id:e,title:t,permalink:a,url:i,width:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.width?r.images[0].source.width:0,height:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.height?r.images[0].source.height:0}))(e.data));return[a.data.after,i.filter(isImage).filter(isLargeEnough)]},PREVIOUS_FILEPATH="Tasker/wallpaper/previous.json",readOrCreatePrevious=(t=PREVIOUS_FILEPATH)=>{try{return JSON.parse(readFile(t)).sort((e,t)=>e&&t?t.displayedLast-e.displayedLast:0).filter((t,e,a)=>!t||e===a.filter(e=>!!e).findIndex(e=>t.id===e.id))}catch(e){"ENOENT"!==e.code&&console.error(e),writeFile(t,"[]")}return[]},writePrevious=(e,t=PREVIOUS_FILEPATH)=>writeFile(t,JSON.stringify(e)),saveImage=(a,i,r=30)=>new Promise((e,t)=>{if(shell(`cd /storage/emulated/0 && curl -L -f -o ${i} ${a} && echo d`,!1,r))return e();t(`w download ${a} to /storage/emulated/0/${i}`)}),sendNotification=(e,t)=>performTask("WallpaperNotification",10,e,t),online=async(e,t)=>{const[a,i]=await getWallpaperPosts(t),r=i.find(t=>!e.find(e=>e&&e.id===t.id));if(!r){if(!a)throw new Error("Can not paginate without a after parameter");return online(e,a)}var[t]=r.url.match(/\.\w{3,4}($|\?)/),t=`Tasker/wallpaper/images/${r.id}${t}`;await saveImage(r.url,t),setWallpaper(t),sendNotification(r.title,`https://reddit.premii.com/#${r.permalink}`),r.displayedLast=Date.now(),e.unshift(r);t=global("%WallpaperMemLength");return t||setGlobal("%WallpaperMemLength",1e3),e.length=t||1e3,writePrevious(e),e},getCachedWithIds=()=>{const e=listFiles("Tasker/wallpaper/images");return e?e.split("\n").map(e=>({id:e.match(/(\w+)\.\w{3,4}/)[1],filePath:e})):[]},offline=e=>{const t=getCachedWithIds(),a=e.filter(e=>!!e);if(!t.length||!e.length)return flash("Could not set offline wallpaper no cached image"),e;const i=a.pop();var r=t.find(({id:e})=>e===i.id);return r||offline(a),setWallpaper(r.filePath),sendNotification(i.title,`https://reddit.premii.com/#${i.permalink}`),i.displayedLast=Date.now(),a.unshift(i),a.length=e.length,writePrevious(a),e},cleanCached=e=>{const t=getCachedWithIds(),a=t.filter(({id:t})=>!e.find(e=>e&&e.id===t));a.forEach(({filePath:e})=>deleteFile(e))};(async()=>{try{sendNotification("Updating wallpaper...");var e,t,a=readOrCreatePrevious(),[,i]=global("%WIFII").match(/>>> (.+) <<</);"CONNECTION"===i?(console.log("online"),e=await online(a),cleanCached(e)):(console.log("offline"),t=await offline(a),cleanCached(t))}catch(e){console.error(e),flash(e.toString())}exit()})();