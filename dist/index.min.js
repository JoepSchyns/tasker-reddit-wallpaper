(()=>{"use strict";const e=this,t="Tasker/wallpaper/previous.json",a=(a,i=t)=>(0,e.writeFile)(i,JSON.stringify(a)),i=(t,a)=>(0,e.performTask)("WallpaperNotification",10,t,a),r=()=>{const t=(0,e.listFiles)("Tasker/wallpaper/images");return t?t.split("\n").map((e=>({id:e.match(/(\w+)\.\w{3,4}/)[1],filePath:e}))):[]},l=t=>{const s=r(),n=t.filter((e=>Boolean(e)));if(!s.length||!t.length)return(0,e.flash)("Could not set offline wallpaper no cached image"),t;const o=n.pop(),d=s.find((({id:e})=>e===o.id));return d||l(n),(0,e.setWallpaper)(d.filePath),i(o.title,`https://reddit.premii.com/#${o.permalink}`),o.displayedLast=Date.now(),n.unshift(o),n.length=t.length,a(n),t},s=l,n=({url:e})=>RegExp(".(jpg|png|jpeg)$","i").test(e),o=({width:e,height:t})=>e>=1080&&t>=1920,d=async(t,r)=>{const[l,s]=await(async t=>{const a=await(0,e.fetch)("https://reddit.com/r/art.json?limit=100"+(t?`&after=${t}`:"")),i=await a.json(),r=i.data.children.map((e=>(({id:e,title:t,permalink:a,url:i,preview:r})=>({id:e,title:t,permalink:a,url:i,width:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.width?r.images[0].source.width:0,height:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.height?r.images[0].source.height:0}))(e.data)));return[i.data.after,r.filter(n).filter(o)]})(r),p=s.find((e=>!t.find((t=>t&&t.id===e.id))));if(!p){if(!l)throw new Error("Can not paginate without a after parameter");return d(t,l)}const[c]=p.url.match(/\.\w{3,4}($|\?)/),h=`Tasker/wallpaper/images/${p.id}${c}`;await((t,a,i=30)=>new Promise(((r,l)=>(0,e.shell)(`cd /storage/emulated/0 && curl -L -f -o "${a}" "${t}" && echo d`,!1,i)?r():l(Error(`Could not download ${t} to /storage/emulated/0/${a}`)))))(p.url,h),(0,e.setWallpaper)(h),i(p.title,`https://reddit.premii.com/#${p.permalink}`),p.displayedLast=Date.now(),t.unshift(p);const g=(0,e.global)("%WallpaperMemLength");return g||(0,e.setGlobal)("%WallpaperMemLength",1e3),t.length=g||1e3,a(t),t},p=d,c=t=>r().filter((({id:e})=>!t.find((t=>t&&t.id===e)))).forEach((({filePath:t})=>(0,e.deleteFile)(t)));(async()=>{try{i("Updating wallpaper...");const a=((a=t)=>{try{return JSON.parse((0,e.readFile)(a)).sort(((e,t)=>e&&t?t.displayedLast-e.displayedLast:0)).filter(((e,t,a)=>!e||t===a.filter((e=>Boolean(e))).findIndex((t=>e.id===t.id))))}catch(t){"ENOENT"!==t.code&&console.error(t),(0,e.writeFile)(a,"[]")}return[]})(),[r,l]=(0,e.global)("%WIFII").match(/>>> (.+) <<</);if("CONNECTION"===l){console.log("online");const e=await p(a);c(e)}else{console.log("offline");const e=await s(a);c(e)}}catch(t){console.error(t),(0,e.flash)(t.toString())}(0,e.exit)()})()})();