(()=>{"use strict";const e=this,t=(t,a)=>{console.log(e.global,e.setGlobal);return(0,e.global)(t)||((0,e.setGlobal)(t,a),a)},a=t("%WallpaperMaxWallpapers",1e3),l="Tasker/wallpaper/previous.json",r="Tasker/wallpaper/images",i=t("%WallpaperClientBaseUrl","https://www.troddit.com"),o=t("%WallpaperRedditSourceUrl","https://reddit.com/r/art.json"),n=t("%WallpaperMinWidth",1080),s=t("%WallpaperMinHeight",1920),d=({url:e})=>RegExp(".(jpg|png|jpeg)$","i").test(e),h=(t,a=l)=>(0,e.writeFile)(a,JSON.stringify(t)),c=(t,a)=>(0,e.performTask)("WallpaperNotification",10,t,a),p=(t=r)=>{const a=(0,e.listFiles)(t);return a?a.split("\n").reduce(((e,t)=>{const a=t.match(/(\w+)\.\w{3,4}$/);return a?(e.push({id:a[1],filePath:t}),e):e}),[]):[]},g=(t,a=r,o=l)=>{console.log("Start offline");const n=p(a),s=t.filter((e=>Boolean(e)));if(!n.length||!t.length)return(0,e.flash)("Could not set offline wallpaper with no cached images"),t;const d=s.pop(),w=n.find((({id:e})=>e===d.id));return w||g(s),(0,e.setWallpaper)(w.filePath),c(d.title,`${i}${d.permalink}`),(0,e.setGlobal)("WallpaperPostUrl",`${i}${d.permalink}`),d.displayedLast=Date.now(),s.unshift(d),s.length=t.length,h(s,o),s},w=g,m=({width:e,height:t})=>e>=n&&t>=s,u=(t,a)=>new Promise(((l,r)=>{const i=new Image;i.onload=function(){const t=document.createElement("canvas"),i=t.getContext("2d"),o=s/this.height;t.width=this.width*o,t.height=s,i.drawImage(this,0,0,t.width,t.height);const n=`echo '${t.toDataURL("image/jpeg",.8).match(/^data:image\/[a-z]+;base64,(?<base>.+)$/).groups.base}' | base64 -d > /storage/emulated/0/${a} && echo done`;return(0,e.shell)(n,!1,45)?l():r(new Error(`shell command failed Tasker JS does not include error, ${n}`))},i.src=t})),f=async(t=[],n,s=r,p=l,g=null)=>{const[w,$]=await(async t=>{const a=await(0,e.fetch)(`${o}?limit=100${t?`&after=${t}`:""}`),l=await a.json(),r=l.data.children.map((e=>(({id:e,title:t,permalink:a,url:l,preview:r})=>({id:e,title:t,permalink:a,url:l,width:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.width?r.images[0].source.width:0,height:r&&r.images&&r.images.length&&r.images[0].source&&r.images[0].source.height?r.images[0].source.height:0}))(e.data)));return[l.data.after,r.filter(d).filter(m)]})(n),b=$.find((e=>!t.find((t=>t&&t.id===e.id))));if(!b){if(!w)throw new Error("Can not paginate without a after parameter");if(Boolean(g)&&g>=Date.now())throw new Error("Could not find new wallpaper within timeout");return f(t,w,s,p)}const[W]=b.url.match(/\.\w{3,4}($|\?)/),k=`${s}/${b.id}${W}`;return await(async(t,a)=>{if((0,e.shell)("curl --help",!1,10))((t,a)=>{const l=`cd /storage/emulated/0 && curl -L -f -o "${a}" "${t}" && echo done`;if(!(0,e.shell)(l,!1,45))throw new Error(`Curl wallpaper download errored with commmand: ${l}`)})(t,a);else{if(!(0,e.shell)("base64 --help",!1,10))throw new Error("Neither curl or base64 commands precent in shell, no methods available to download image");await u(t,a)}})(b.url,k),(0,e.setWallpaper)(k),c(b.title,`${i}${b.permalink}`),(0,e.setGlobal)("WallpaperPostUrl",`${i}${b.permalink}`),b.displayedLast=Date.now(),t.unshift(b),t.length=a,h(t,p),t},$=async(e=[],t,a=r,i=l,o=3e4)=>{console.log("Start online");const n=Date.now()+o;return await f(e,t,a,i,n)};(async()=>{try{c("Updating wallpaper...");const t=((t=l)=>{try{return JSON.parse((0,e.readFile)(t)).sort(((e,t)=>e&&t?t.displayedLast-e.displayedLast:0)).filter(((e,t,a)=>!e||t===a.filter((e=>Boolean(e))).findIndex((t=>e.id===t.id))))}catch(a){"ENOENT"!==a.code&&console.error(a),(0,e.writeFile)(t,"[]")}return[]})(),[a,r]=(0,e.global)("%WIFII").match(/>>> (.+) <<</);(t=>{p().filter((({id:e})=>!t.find((t=>t&&t.id===e)))).forEach((({filePath:t})=>(0,e.deleteFile)(t)))})(await(!(0,e.global)("sdk")&&process.argv.includes("--online")?$:!(0,e.global)("sdk")&&process.argv.includes("--offline")?w:"CONNECTION"===r?$:w)(t))}catch(t){console.error(t),(0,e.flash)(t.toString())}(0,e.exit)()})()})();